#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const configDir = path.join(__dirname, 'metadata-config');
const outputFile = path.join(__dirname, 'supabase/functions/mcp-server/metadata_bundled.ts');

console.log('ðŸ“¦ Bundling metadata from:', configDir);

const types = fs.readFileSync(path.join(configDir, 'types.ts'), 'utf8');
const theloopgptMetadata = fs.readFileSync(path.join(configDir, 'theloopgptMetadata.ts'), 'utf8');
const toolDescriptions = fs.readFileSync(path.join(configDir, 'toolDescriptions.ts'), 'utf8');
const routingHints = fs.readFileSync(path.join(configDir, 'routingHints.ts'), 'utf8');
const indexFull = fs.readFileSync(path.join(configDir, 'index.ts'), 'utf8');

function removeImports(content) {
  return content
    // Remove: export type { ... } from "..."
    .replace(/export\s+type\s*\{[^}]*\}\s*from\s+['"].*['"];?\s*/gs, '')
    // Remove: export { ... } from "..." (multiline)
    .replace(/export\s*\{[^}]*\}\s*from\s+['"].*['"];?\s*/gs, '')
    // Remove: import type { ... } from "..."
    .replace(/^import\s+type\s+\{[^}]+\}\s+from\s+['"].*['"];?\s*$/gm, '')
    // Remove: import type ... from "..."
    .replace(/^import\s+type\s+.*from\s+['"].*['"];?\s*$/gm, '')
    // Remove: import ... from "..."
    .replace(/^import\s+.*from\s+['"].*['"];?\s*$/gm, '')
    // Clean up extra blank lines
    .replace(/\n\n\n+/g, '\n\n')
    // Remove orphaned closing brackets and semicolons
    .replace(/^\s*\]\s*$/gm, '')
    .replace(/^\s*\};\s*$/gm, '')
    .trim();
}

// For index.ts, we only want the convenience functions section (lines 89+)
const indexLines = indexFull.split('\n');
const convenienceFunctionsStart = indexLines.findIndex(line => line.includes('// CONVENIENCE FUNCTIONS'));
const indexConvenienceFunctions = indexLines.slice(convenienceFunctionsStart).join('\n');

const header = `/**
 * BUNDLED METADATA - AUTO-GENERATED
 * DO NOT EDIT THIS FILE DIRECTLY
 * Generated from metadata-config/* files
 * Run: node bundle-metadata.js to regenerate
 */

// ============================================================================
// TYPES
// ============================================================================
`;

const parts = [
  header,
  removeImports(types),
  '\n// ============================================================================\n// THELOOPGPT METADATA\n// ============================================================================\n',
  removeImports(theloopgptMetadata),
  '\n// ============================================================================\n// TOOL DESCRIPTIONS\n// ============================================================================\n',
  removeImports(toolDescriptions),
  '\n// ============================================================================\n// ROUTING HINTS\n// ============================================================================\n',
  removeImports(routingHints),
  '\n',
  indexConvenienceFunctions
];

const bundled = parts.join('');

fs.writeFileSync(outputFile, bundled);
console.log('âœ… Bundled metadata written to:', outputFile);
console.log('ðŸ“Š File size:', (fs.statSync(outputFile).size / 1024).toFixed(2), 'KB');

// Verify the functions are present
const functionCount = (bundled.match(/export function/g) || []).length;
console.log('ðŸ“Š Export functions found:', functionCount);

// Verify key functions
const hasGetCompleteMetadata = bundled.includes('export function getCompleteMetadata');
const hasGetToolWithRouting = bundled.includes('export function getToolWithRouting');
const hasMcpServerInfo = bundled.includes('export const MCP_SERVER_INFO');

console.log('âœ… getCompleteMetadata:', hasGetCompleteMetadata ? 'YES' : 'NO');
console.log('âœ… getToolWithRouting:', hasGetToolWithRouting ? 'YES' : 'NO');
console.log('âœ… MCP_SERVER_INFO:', hasMcpServerInfo ? 'YES' : 'NO');

// Check for syntax errors
const hasOrphanedBrackets = bundled.match(/^\s*\]\s*$/m) || bundled.match(/^\s*\};\s*$/m);
console.log('âœ… No orphaned brackets:', !hasOrphanedBrackets ? 'YES' : 'NO');
