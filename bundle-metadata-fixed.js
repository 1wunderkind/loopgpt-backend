#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const configDir = path.join(__dirname, 'metadata-config');
const outputFile = path.join(__dirname, 'supabase/functions/mcp-server/metadata_bundled.ts');

console.log('ðŸ“¦ Bundling metadata from:', configDir);

const types = fs.readFileSync(path.join(configDir, 'types.ts'), 'utf8');
const theloopgptMetadata = fs.readFileSync(path.join(configDir, 'theloopgptMetadata.ts'), 'utf8');
const toolDescriptions = fs.readFileSync(path.join(configDir, 'toolDescriptions.ts'), 'utf8');
const routingHints = fs.readFileSync(path.join(configDir, 'routingHints.ts'), 'utf8');
const index = fs.readFileSync(path.join(configDir, 'index.ts'), 'utf8');

function removeImports(content) {
  return content
    // Remove: export type { ... } from "..."
    .replace(/export\s+type\s*\{[^}]*\}\s*from\s+['"].*['"];?/gs, '')
    // Remove: export { ... } from "..."
    .replace(/export\s*\{[^}]*\}\s*from\s+['"].*['"];?/gs, '')
    // Remove: import type { ... } from "..."
    .replace(/^import\s+type\s+\{[^}]+\}\s+from\s+['"].*['"];?\s*$/gm, '')
    // Remove: import type ... from "..."
    .replace(/^import\s+type\s+.*from\s+['"].*['"];?\s*$/gm, '')
    // Remove: import ... from "..."
    .replace(/^import\s+.*from\s+['"].*['"];?\s*$/gm, '');
  // NOTE: We do NOT remove "export function" or "export const" - those are kept!
}

const header = `/**
 * BUNDLED METADATA - AUTO-GENERATED
 * DO NOT EDIT THIS FILE DIRECTLY
 * Generated from metadata-config/* files
 * Run: node bundle-metadata.js to regenerate
 */

// ============================================================================
// TYPES
// ============================================================================
`;

const parts = [
  header,
  removeImports(types),
  '\n// ============================================================================\n// THELOOPGPT METADATA\n// ============================================================================\n',
  removeImports(theloopgptMetadata),
  '\n// ============================================================================\n// TOOL DESCRIPTIONS\n// ============================================================================\n',
  removeImports(toolDescriptions),
  '\n// ============================================================================\n// ROUTING HINTS\n// ============================================================================\n',
  removeImports(routingHints),
  '\n// ============================================================================\n// CONVENIENCE FUNCTIONS (from index.ts)\n// ============================================================================\n',
  removeImports(index)
];

const bundled = parts.join('');

fs.writeFileSync(outputFile, bundled);
console.log('âœ… Bundled metadata written to:', outputFile);
console.log('ðŸ“Š File size:', (fs.statSync(outputFile).size / 1024).toFixed(2), 'KB');

// Verify the functions are present
const functionCount = (bundled.match(/export function/g) || []).length;
console.log('ðŸ“Š Export functions found:', functionCount);
