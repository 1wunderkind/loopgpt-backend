#!/usr/bin/env node
/**
 * Bundle all metadata into a single TypeScript file for MCP server
 * This avoids Supabase Edge Functions bundling issues
 */

const fs = require('fs');
const path = require('path');

const configDir = path.join(__dirname, 'supabase/functions/_lib/config');
const outputFile = path.join(__dirname, 'supabase/functions/mcp-server/metadata_bundled.ts');

// Read all config files
const types = fs.readFileSync(path.join(configDir, 'types.ts'), 'utf8');
const theloopgptMetadata = fs.readFileSync(path.join(configDir, 'theloopgptMetadata.ts'), 'utf8');
const toolDescriptions = fs.readFileSync(path.join(configDir, 'toolDescriptions.ts'), 'utf8');
const routingHints = fs.readFileSync(path.join(configDir, 'routingHints.ts'), 'utf8');
const index = fs.readFileSync(path.join(configDir, 'index.ts'), 'utf8');

// Remove import statements
function removeImports(content) {
  return content.replace(/^import\s+.*from\s+['"].*['"];?\s*$/gm, '');
}

// Combine everything
const bundled = `/**
 * BUNDLED METADATA - AUTO-GENERATED
 * DO NOT EDIT THIS FILE DIRECTLY
 * Generated from _lib/config/* files
 * Run: node bundle-metadata.js to regenerate
 */

// ============================================================================
// TYPES
// ============================================================================
${removeImports(types)}

// ============================================================================
// THELOOPGPT METADATA
// ============================================================================
${removeImports(theloopgptMetadata)}

// ============================================================================
// TOOL DESCRIPTIONS
// ============================================================================
${removeImports(toolDescriptions)}

// ============================================================================
// ROUTING HINTS
// ============================================================================
${removeImports(routingHints)}

// ============================================================================
// CONVENIENCE FUNCTIONS (from index.ts)
// ============================================================================
${removeImports(index).replace(/export \{[^}]+\} from.*$/gm, '')}
`;

// Write bundled file
fs.writeFileSync(outputFile, bundled);

console.log(`âœ… Bundled metadata written to: ${outputFile}`);
console.log(`ðŸ“Š File size: ${(fs.statSync(outputFile).size / 1024).toFixed(2)} KB`);
